#!/usr/bin/python

from jinja2.exceptions import TemplateNotFound
import jinja2
import sys, os
import argparse

import echomsg
from echomsg import MessagesRegistry, parseFile, formatConstant, DescriptionError, set_default_language

def render_language(language, extension, registry, outdir):
    loader = jinja2.FileSystemLoader(os.path.join(os.path.dirname(echomsg.__file__), "templates"))
    env = jinja2.Environment(loader=loader)
    env.filters["constant"] = lambda x: formatConstant(x, language=language)
    template = env.get_template('{}.tpl'.format(language))

    set_default_language(language)
    
    context = {}
    context['basename'] = os.path.splitext(os.path.basename(f))[0]
    context['namespace'] = registry.namespace
    context['registry'] = registry

    if not outdir is None:
        if not os.path.exists(outdir):
            os.makedirs(outdir)
        with open(os.path.join(outdir, "{}.{}".format(context['basename'], extension)), "w") as out:
            out.write(template.render(context))


if __name__ == '__main__':

    parser = argparse.ArgumentParser(description='Process some integers.')
    parser.add_argument('files', metavar='file', type=str, nargs='+',
                        help='Message files to process')

    parser.add_argument('-p', metavar='paths', type=str, action='append', default=[],
                        help='Message files to process', dest='paths')

    parser.add_argument('--python-outdir', metavar='dir', type=str,
                        help='Output directory for Python files', dest='outdir_python')

    parser.add_argument('--cpp-outdir', metavar='dir', type=str,
                        help='Output directory for C++ files', dest='outdir_cpp')

    args = parser.parse_args()

    args.paths.insert(0, os.path.join(os.path.dirname(echomsg.__file__), "messages"))
    args.paths.append(".")

    for f in args.files:
        registry = MessagesRegistry()
        registry.namespace = ''
        try:
            parseFile(f, registry, args.paths)
        except DescriptionError, e:
            print "Processing error: {}".format(e)
            sys.exit(1)
        except:
            import traceback
            traceback.print_exc()
            sys.exit(1)

        render_language("cpp", "h", registry, args.outdir_cpp)
        render_language("python", "py", registry, args.outdir_python)
